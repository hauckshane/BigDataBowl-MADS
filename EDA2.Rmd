---
title: "More EDA"
author: "Shane Hauck"
date: "2023-11-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(gganimate)
theme_set(theme_bw())

library(sportyR)
field_params <- list(
  field_apron = "springgreen3",
  field_border = "springgreen3",
  offensive_endzone = "springgreen3",
  defensive_endzone = "springgreen3",
  offensive_half = "springgreen3",
  defensive_half = "springgreen3"
)

nfl_field <- function(xlims) {
  geom_football(
    league = "nfl",
    display_range = "full",
    x_trans = 60,
    y_trans = 26.6667,
    xlims = xlims,
    color_updates = field_params
  )
}
```


```{r}
players <- read_csv("data/players.csv")
plays <- read_csv("data/plays.csv")
tracking_week_2 <- read_csv("data/tracking_week_2.csv") %>%
  mutate(
    # make all plays go from left to right
    x = ifelse(playDirection == "left", 120 - x, x),
    y = ifelse(playDirection == "left", 160 / 3 - y, y),
    # flip player direction and orientation
    dir = ifelse(playDirection == "left", dir + 180, dir),
    dir = ifelse(dir > 360, dir - 360, dir),
    o = ifelse(playDirection == "left", o + 180, o),
    o = ifelse(o > 360, o - 360, o)
  )

focused_df <- left_join(tracking_week_2, plays) %>%
  left_join(players) %>%
  select(
    gameId, playId, nflId, position, frameId, x, y, s, a, dis, o, dir, event,
    playDescription, ballCarrierId, club, possessionTeam, defensiveTeam,
    playResult, playNullifiedByPenalty, offenseFormation, defendersInTheBox,
    expectedPoints, expectedPointsAdded
  )
```


```{r}
# Keep plays where a snap occurs (see kaggle for description of designed rushes)
snapped_plays <- focused_df %>%
  filter(event == "ball_snap") %>%
  distinct(gameId, playId) %>%
  left_join(focused_df)

# Filter out any quick passing plays
designed_runs <- snapped_plays %>%
  filter(event %in% c("run", "lateral", "handoff")) %>%
  distinct(gameId, playId) %>%
  left_join(snapped_plays)

# Accurately removed passing plays that included a snap of the ball
snapped_plays %>%
  filter(event == "pass_forward") %>%
  distinct(gameId, playId) %>%
  nrow()
```


```{r}
# Add variable for the section of the field where the play went and playside
designed_runs <- designed_runs %>%
  mutate(wherePlayWent = str_extract(playDescription, "(left|right|up the) (guard|tackle|end|middle)")) %>%
  mutate(ballY_preSnap = ifelse(frameId == 5 & club == "football", y, NA)) %>%
  group_by(gameId, playId) %>%
  fill(ballY_preSnap, .direction = c("updown")) %>%
  mutate(ballCarrierY = ifelse(nflId == ballCarrierId, y, NA)) %>%
  fill(ballCarrierY, .direction = c("updown")) 

# plays where all offensive lineman and running backs take same same first step
sameDir <- designed_runs %>%
  filter(position %in% c("T", "G", "C") # ) %>%
  | nflId == ballCarrierId) %>%
  group_by(gameId, playId) %>%
  mutate(ball_snap_frame = ifelse(event == "ball_snap", frameId, NA)) %>%
  fill(ball_snap_frame, .direction = c("updown")) %>%
  filter(frameId %in% c(ball_snap_frame)) %>%
  mutate(dir_atSnap = ifelse(dir <= 180, "left", "right")) %>%
  mutate(same_dir = ifelse(all(dir_atSnap == first(dir_atSnap)), "yes", "no")) %>%
  distinct(gameId, playId, same_dir) 

# plays where all offensive lineman and running backs take same same first step
sameDir_yes <- sameDir %>% filter(same_dir == "yes") %>% distinct(gameId, playId)

# tracking data where all offensive lineman and running backs take same same first step
WK2_SameDirection_TrackData <- left_join(sameDir_yes, designed_runs)
```

# MARION STOP HERE
# USE WK2_SameDirection_TrackData AS TRACKING DATA TO START THE ANALYSIS







```{r}
DL_info <- designed_runs %>%
  filter(club == defensiveTeam | club == "football") %>%
  group_by(gameId, playId) %>%
  # Identifying the frame before the ball snap
  mutate(pre_ball_snap_frame = ifelse(event == "ball_snap", frameId - 1, NA)) %>%
  fill(pre_ball_snap_frame, .direction = "updown") %>%
  filter(frameId == pre_ball_snap_frame) %>%
  # Assigning ball position
  mutate(ball_x = ifelse(club == "football", x, NA),
         ball_y = ifelse(club == "football", y, NA)) %>%
  fill(ball_x, ball_y, .direction = "updown") %>%
  filter(club != "football") %>%
  # Calculating distances and determining if defenders are in the box and on the LOS
  mutate(distance_to_ball = sqrt((x - ball_x)^2 + (y - ball_y)^2),
         rank_distance_to_ball = rank(distance_to_ball),
         isInBox = ifelse(rank_distance_to_ball <= defendersInTheBox, "yes", "no"),
         distance_to_LOS = abs(x - ball_x),
         isonLOS = ifelse(distance_to_LOS <= 2, "yes", "no")) %>%
  select(gameId, playId, nflId, pre_ball_snap_frame, isInBox, isonLOS) 

processing <- right_join(DL_info, designed_runs) %>%
  mutate(isInBox = ifelse(is.na(isInBox), "no", isInBox),
         isonLOS = ifelse(is.na(isonLOS), "no", isonLOS)) %>%
  fill(pre_ball_snap_frame, .direction = c("updown")) %>%
  filter(frameId == pre_ball_snap_frame) %>%
  filter(club == possessionTeam |
    (isInBox == "yes" & isonLOS == "yes")) %>%
  filter(club != possessionTeam |
    position %in% c("T", "G", "C") |
    nflId == ballCarrierId) %>%
  mutate(isOLM = ifelse(position %in% c("T", "G", "C"), 1, 0)) %>%
  group_by(gameId, playId) %>%
  mutate(numOLM = sum(isOLM),
         numOLM = ifelse(numOLM == 0, max(numOLM), numOLM)) %>%
  filter(numOLM > 0) %>%
  mutate(numonLOSInBox = sum(isonLOS == "yes" & isInBox == "yes")) %>%
  distinct(gameId, playId, nflId, isInBox, isonLOS, numOLM, numonLOSInBox) %>%
  mutate(OLM_outnumbered = ifelse(numOLM <= numonLOSInBox, "yes", "no"),
         OLM_upby = numOLM - numonLOSInBox) %>%
  left_join(sameDir) %>%
  mutate(same_dir_exception = ifelse(same_dir == "no" & OLM_outnumbered == "no", "yes", "no")) %>%
  right_join(designed_runs) %>%
  filter(same_dir_exception == "yes") %>%
  filter(position %in% c("T", "G", "C") |
           nflId == ballCarrierId) %>%
  mutate(ball_snap_frame = ifelse(event == "ball_snap", frameId, NA)) %>%
  fill(ball_snap_frame, .direction = c("updown")) %>%
  filter(frameId %in% c(ball_snap_frame)) %>%
  mutate(dir_atSnap = ifelse(dir <= 180, "left", "right")) %>%
  # Count the number of players who went right and who went left
  group_by(gameId, playId) %>%
  mutate(numLeft = sum(dir_atSnap == "left"),
         numRight = sum(dir_atSnap == "right")) %>%
  # Find the direction that the minority of players went
  mutate(minorityDir = ifelse(numLeft < numRight, "left", "right")) %>%
  mutate(ballCarrier_majorityDir = ifelse(nflId == ballCarrierId & dir_atSnap == minorityDir, "no", "yes")) %>%
  # apply ballCarrier_majorityDir to all players for game and play
  group_by(gameId, playId) %>%
  mutate(ballCarrier_majorityDir = ifelse(any(ballCarrier_majorityDir == "yes"), "yes", "no")) %>%
  filter(ballCarrier_majorityDir == "yes") %>%
  filter(nflId != ballCarrierId) %>%
  # Count the number of players that went the minority direction
  mutate(numMinorityDir = ifelse(minorityDir == "left", numLeft, numRight),
         wentMinority = ifelse(dir_atSnap == minorityDir, "yes", "no")) %>%
  filter(numMinorityDir == OLM_upby) %>%
  select(gameId, playId, nflId, position, x, y, club, possessionTeam, wherePlayWent, dir_atSnap, minorityDir, wentMinority)
  
all_LM <- left_join(DL_info, designed_runs) %>%
  mutate(ball_snap_frame = ifelse(event == "ball_snap", frameId, NA)) %>%
  fill(ball_snap_frame, .direction = c("updown")) %>%
  filter(frameId %in% c(ball_snap_frame)) %>%
  filter(isInBox == "yes" & isonLOS == "yes") %>%
  select(gameId, playId, nflId, position, x, y, club, possessionTeam, wherePlayWent) %>%
  rbind(processing)
  

# Define the sideline values
left_sideline_y <- 50
right_sideline_y <- 0

# Function to find the nearest offensive lineman or sideline in the direction of the play
find_nearest_ol_or_sideline <- function(ol_row, ol_df) {
  if (ol_row$minorityDir == "right") {
    nearest_ol <- ol_df %>%
      filter(gameId == ol_row$gameId, playId == ol_row$playId, nflId != ol_row$nflId, y > ol_row$y) %>%
      arrange(y) %>%
      slice(1) %>%
      pull(y)
    return(ifelse(length(nearest_ol) == 0, left_sideline_y, nearest_ol))
  } else {
    nearest_ol <- ol_df %>%
      filter(gameId == ol_row$gameId, playId == ol_row$playId, nflId != ol_row$nflId, y < ol_row$y) %>%
      arrange(desc(y)) %>%
      slice(1) %>%
      pull(y)
    return(ifelse(length(nearest_ol) == 0, right_sideline_y, nearest_ol))
  }
}

# Function to check for a defender in the gap
is_defender_in_gap <- function(ol_row, ol_df, def_df) {
  nearest_ol_y <- find_nearest_ol_or_sideline(ol_row, ol_df)
  gap_min_y <- min(ol_row$y, nearest_ol_y)
  gap_max_y <- max(ol_row$y, nearest_ol_y)
  
  any_defender_in_gap <- any(
    def_df$gameId == ol_row$gameId & 
    def_df$playId == ol_row$playId &
    def_df$y >= gap_min_y & 
    def_df$y <= gap_max_y
  )
  
  return(any_defender_in_gap)
}

# Apply the function to the offensive linemen who went in the minority direction
ol_df <- all_LM %>% filter(position %in% c("T", "G", "C"))
def_df <- all_LM %>% filter(!(position %in% c("T", "G", "C")))
ol_minority_df <- all_LM %>% filter(wentMinority == "yes")

ol_minority_df <- ol_minority_df %>%
  rowwise() %>%
  mutate(defenderInGap = is_defender_in_gap(cur_data_all(), ol_df, def_df))

ol_tracking_data <- ol_minority_df %>% 
  group_by(gameId, playId) %>%
  mutate(all_defenderInGap = all(defenderInGap == FALSE)) %>%
  filter(all_defenderInGap == TRUE) %>%
  distinct(gameId, playId) %>%
  left_join(all_LM) %>%
  filter(club == possessionTeam) %>%
  distinct(gameId, playId, nflId, wentMinority) %>%
  left_join(designed_runs, by = c("gameId", "playId", "nflId")) 



# Assuming 'ol_tracking_data' contains tracking data with frameId, gameId, playId, nflId, x, y
# and 'ol_minority_df' contains linemen who went minority with gameId, playId, nflId, minorityDir

# Define the snap frame
snap_frame_id <- 6

# Function to check if the offensive lineman is pulling
is_lineman_pulling <- function(ol_row, tracking_data, snap_frame_id) {
  print(paste("Checking for gameId:", ol_row$gameId, "playId:", ol_row$playId, "nflId:", ol_row$nflId))
  # Filter the tracking data for the lineman in question
  lineman_tracking <- tracking_data %>%
    filter(gameId == ol_row$gameId, playId == ol_row$playId, nflId == ol_row$nflId)

  # Get the lineman's direction of movement at the snap and the next few frames
  direction_data <- lineman_tracking %>%
    filter(frameId >= snap_frame_id & frameId <= snap_frame_id + 3) %>%
    select(frameId, dir)

  if (nrow(direction_data) < 4) {
    return(FALSE) # Not enough data to determine direction
  }

  # Analyze direction change for pulling
  initial_dir <- direction_data$dir[1]
  subsequent_dirs <- direction_data$dir[-1]

  # Check for significant lateral direction change
  is_pulling <- FALSE
  if (ol_row$minorityDir == "left") {
    # Check for direction change towards the right
    is_pulling <- any(subsequent_dirs > initial_dir + 45 & subsequent_dirs < initial_dir + 135)
  } else {
    # Check for direction change towards the left
    is_pulling <- any(subsequent_dirs < initial_dir - 45 & subsequent_dirs > initial_dir - 135)
  }

  return(is_pulling)
}

# Apply the pulling check
ol_minority_df <- ol_minority_df %>%
  rowwise() %>%
  mutate(isPulling = is_lineman_pulling(cur_data(), ol_tracking_data, snap_frame_id)) %>%
  ungroup()


```

```{r}
ggplot(all_LM %>% filter(gameId == 2022091803, playId == 1345), aes(x = x, y = y, color = club)) +
  geom_point()
```



```{r}
test_run <- designed_runs %>% filter(gameId == 2022091801, playId == 2460)
nfl_field(c(0,100)) +
  geom_point(
    data = test_run, aes(x = x, y = y, color = club),
    show.legend = FALSE,
    size = 3
  ) +
  transition_time(frameId) +
  scale_color_manual(values = c("purple", "yellow", "white"))
```

