---
title: "Graphs"
author: "Shane Hauck, Marion Haney, Devin Basley, Vinay Maruri"
date: "2024-1-3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gganimate)
theme_set(theme_bw())
```

```{r}
library(sportyR)
field_params <- list(
  field_apron = "lightgray",
  field_border = "lightgray",
  offensive_endzone = "lightgray",
  defensive_endzone = "lightgray",
  offensive_half = "lightgray",
  defensive_half = "lightgray"
)

field_params <- list(
  field_apron = "#83f28f",
  field_border = "#83f28f",
  offensive_endzone = "#003594",
  defensive_endzone = "#c9243f",
  offensive_half = "#83f28f",
  defensive_half = "#83f28f",
  sideline = "black",
  goalline = "black",
  major_yard_line = "black",
  minor_yard_line = "black",
  yardage_marker = "black",
  endline = "black",
  field_border = "black",
  directional_arrow = "black"
  
)

nfl_field <- function(xlims) {
  geom_football(
    league = "nfl",
    display_range = "in_bounds_only",
    x_trans = 60,
    y_trans = 26.6667,
    xlims = xlims,
    color_updates = field_params
  ) 
    
}
```


Read in data files:

```{r}
# From Edge-Intensity_Rating
maxChangesEIR <- read_csv("data/BC_and_ES_information.csv")

combined_data <- read_csv("data/all_processed_data.csv")
```


EDA (to check work)

Histogram of total change (angle change + orientation change)
```{r}
ggplot(data = combined_data, aes(x = total_change_at_max_change)) +
  geom_histogram()
```


Filter the data: total change < 30 (where most of the data are)
```{r}
# Did this in EIR
max_range <- 30
filtered_data <- filter(combined_data, total_change_at_max_change < max_range)
```


Create buckets for EDA
```{r}
bucket_size <- 5
filtered_data$bucket <- cut(filtered_data$total_change, breaks = seq(0, max_range, bucket_size), 
                                            labels = FALSE, right = FALSE)
```


Histogram of total change (angle change + orientation change) for each bucket
```{r}
ggplot(data = filtered_data, aes(x = total_change)) +
  geom_histogram() +
  facet_wrap(~factor(bucket))
```

Get average EPA by bucket
```{r}
avg_epa_by_bucket <- filtered_data %>%
  group_by(bucket) %>%
  reframe(epa = mean(expectedPointsAdded),
            min_change = (bucket - 1) * bucket_size,
            max_change = bucket * bucket_size) %>%
  unique()
```


# Polar coordinate graphs


## EPA by total change

**Plot 1**
```{r}
plotdf <- maxChangesEIR %>% 
  select(total_change_at_max_change, expectedPointsAdded) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(0, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEPA = mean(expectedPointsAdded))
```

```{r}
# Plot
ggplot(plotdf, aes(x = bucket_angle_min, y = 1, fill = meanEPA)) +
  geom_col(color = "black", size = .15) +
  coord_polar() +
  scale_x_continuous(limits = c(0,360)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(low = "darkcyan", high = "firebrick4", midpoint = mean(plotdf$meanEPA, na.rm = TRUE)) +
  labs(title = "Ball Carrier's Greatest Total Change of Direction's Effect On EPA",
       subtitle = "As the ball carrier makes more significant maximal changes in direction, \nthe average offense success decreases.", 
       x = "Ball Carrier Total Change of Direction", y = "", fill = "Expected Points Added") +
  #theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"))
```


## EPA by relative total change



**Plot 2**
```{r}
plotdf <- maxChangesEIR %>% 
  filter(abs(relative_total_change) < 25) %>%
  select(relative_total_change, expectedPointsAdded) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-25, 25, 5))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket))),
         bucket_angle_max = as.numeric(gsub("\\[|\\]", "", gsub(".*,(.*)\\]", "\\1", as.character(bucket)))),
         bucket_angle_mean = (bucket_angle_min + bucket_angle_max) / 2) %>%
  mutate(meanEPA = mean(expectedPointsAdded))
```

```{r}
# Plot
ggplot(plotdf, aes(x = bucket_angle_mean, y = 1)) +
  geom_col(aes(fill = meanEPA), color = "black", size = .1) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-180,180)) +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = "Ball Carrier's Greatest Relative Total Change of Direction's \nEffect On EPA", 
       subtitle = "Edges that force the ball carrier to make a more drastic cutback to center or \nbounce to outside have a positive effect on EPA for the defense.",
       x = "Ball Carrier Relative Total Change of Direction", y = " ", 
       caption = "Relative Change < 0 = Cutbacks  \nRelative Change = 0 = Dive \nRelative Change > 0 = Bounces",
       fill = "Expected Points Added")  +
  scale_fill_gradient2(low = "darkcyan", high = "firebrick4", midpoint = mean(plotdf$meanEPA, na.rm = TRUE)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"),
        plot.caption = element_text(size = 18))

```


## EPA of relative total change by play side

**Plot 3**
```{r}
plotdf3 <- maxChangesEIR %>% 
  filter(abs(relative_total_change) < 25) %>%
  select(relative_total_change, expectedPointsAdded, playSide) %>%
  group_by(playSide) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-25, 25, 15))
         ) %>%
  group_by(playSide, bucket) %>%
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket))),
         bucket_angle_max = as.numeric(gsub("\\[|\\]", "", gsub(".*,(.*)\\]", "\\1", as.character(bucket)))),
         bucket_angle_mean = (bucket_angle_min + bucket_angle_max) / 2) %>%
  mutate(meanEPA = mean(expectedPointsAdded)) %>%
  mutate(playSidedescr = ifelse(playSide == "left", "Plays to the Left", "Plays to the Right"))
```

```{r}
# Plot
ggplot(plotdf3, aes(x = bucket_angle_mean, y = 1)) +
  geom_col(aes(fill = meanEPA), color = "black", size = .25) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-50,50)) +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = "EPA by Direction of Greatest Cut", x = "Greatest Change of Direction", y = " ", subtitle = "Considering the direction of the playside:", fill = "EPA")  +
  scale_fill_gradient2(low = "darkcyan", high = "firebrick4", midpoint = mean(maxChangesEIR$expectedPointsAdded, na.rm = TRUE)) +
  facet_wrap(~playSidedescr) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.key.size = unit(1, "cm"),
        strip.text = element_text(size = 18))
```


# EIR impact on change of direction
**Plot 4**
```{r}
EIR_TC_plot <- maxChangesEIR %>%
  select(total_change_at_max_change, max_EIR_atMaxChange) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(0, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEIR = mean(max_EIR_atMaxChange))

ggplot(EIR_TC_plot, aes(x = bucket_angle_min, y = 1, fill = meanEIR)) +
  geom_col(color = "black", size = .15) +
  coord_polar() +
  scale_x_continuous(limits = c(0,360)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(low = "midnightblue", high = "sienna2", midpoint = mean(EIR_TC_plot$meanEIR, na.rm = TRUE)) +
  labs(title = "Edge Intensity Rating by Greatest Total Change of Direction", 
       subtitle = "Edges being set more intensely are associated with greater total change of ball carrier direction.", 
       x = "Ball Carrier Total Change of Direction", y = "", 
       fill = "Edge Intensity Rating") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"))
```

# EIR impact on relative change of direction
**Plot 5**

```{r}
EIR_RTC_plot <- maxChangesEIR %>%
  select(relative_total_change, max_EIR_atMaxChange) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-30, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEIR = mean(max_EIR_atMaxChange))

ggplot(EIR_RTC_plot, aes(x = bucket_angle_min, y = 1, fill = meanEIR)) +
  geom_col(color = "black", size = 0.15) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-180,180)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(high = "sienna2", low = "midnightblue", midpoint = mean(maxChangesEIR$max_EIR_atMaxChange, na.rm = TRUE)) +
  labs(title = "Edge Intensity Rating by Relative Greatest Total Change of Direction", 
       subtitle = "Edges set more intensely are associated with greater total change of ball carrier direction.",
       x = "Ball Carrier Relative Total Change of Direction", y = " ", 
       caption = "Relative Change < 0 = Cutbacks  \nRelative Change = 0 = Dive \nRelative Change > 0 = Bounces",
       fill = "Edge Intensity Rating")  +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"),
        plot.caption = element_text(size = 18))
```

# EIR impact on change of direction over time
**Animation 1**
```{r}
quickest_set_plot <- maxChangesEIR %>%
  select(frames_from_start_atMaxChange, max_EIR_atMaxChange, total_change_at_max_change) %>%
  mutate(
    framesBucket = case_when(
      frames_from_start_atMaxChange <= 5 ~ "1",
      frames_from_start_atMaxChange > 5 & frames_from_start_atMaxChange <= 10 ~ "2",
      frames_from_start_atMaxChange > 10 & frames_from_start_atMaxChange <= 15 ~ "3",
      frames_from_start_atMaxChange > 15 & frames_from_start_atMaxChange <= 20 ~ "4",
      frames_from_start_atMaxChange > 20 & frames_from_start_atMaxChange <= 30 ~ "5",
      frames_from_start_atMaxChange > 30 ~ "6",
      TRUE ~ NA_character_  
    )
  ) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(-30, 30, 6))) %>%
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  group_by(framesBucket, bucket) %>%
  mutate(expected_EIR = mean(max_EIR_atMaxChange)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(
    frames_sequence = list(
      if (framesBucket == "1") {
        1:5
      } else if (framesBucket == "2") {
        6:10
      } else if (framesBucket == "3") {
        11:15
      } else if (framesBucket == "4") {
        15:20
      } else if (framesBucket == "5") {
        21:30
      } else if (framesBucket == "6") {
        31:40
      }
      else {
        integer(0)  # Empty vector for NA or unexpected values
      }
    )
  ) %>%
  unnest(frames_sequence) %>%
  select(-frames_from_start_atMaxChange) %>%
  rename(frames_from_start_atMaxChange = frames_sequence) %>%
  mutate(seconds_from_start_atMaxChange = frames_from_start_atMaxChange / 10) 
  
p1 <- ggplot(quickest_set_plot, aes(x = bucket_angle_min, y = 1, fill = expected_EIR)) +
  geom_col(color = "black", size = .05) +
  coord_polar() +
  scale_x_continuous(limits = c(0,360)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(high = "sienna2", low = "midnightblue", midpoint = mean(maxChangesEIR$max_EIR_atMaxChange, na.rm = TRUE)) +
  labs(title = "EIR for Total Change of Direction Seconds After Handoff",
       subtitle  = "\nSeconds after handoff: {closest_state}", 
       x = "Ball Carrier Total Change of Direction", y = "", 
       fill = "Edge Intensity Rating") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 12),
        legend.key.size = unit(2, "cm"))+
  transition_states(seconds_from_start_atMaxChange, transition_length = 0, state_length = 2, wrap = TRUE) +
  exit_fade() +
  ease_aes('linear') 
animate(p1, start_pause = 10, end_pause = 10, fps = 10)
```



# Animation for Angle Change

```{r}
combined_data <- read_csv("data/all_processed_data.csv")
```



```{r}
animation_data <- combined_data %>% filter(gamePlayId == "2022100910 2460")

# Frame where you want to pause
pause_frame <- animation_data$frameId_at_max_change[1]

# Number of times to duplicate the pause frame (5 seconds * fps)
fps <- 10 # frames per second
pause_length <- fps * 5 


# Duplicate the pause frame and create increasing frameIds
pause_data <- animation_data %>% filter(frameId == pause_frame) %>% filter(nflId == ballCarrierId | nflId == edgeSetterId_atFrame)
pause_data_replicated <- pause_data %>%
  slice(rep(1, pause_length)) %>%
  mutate(frameId = frameId + 0:(pause_length - 1))

# Adjust frameId for subsequent frames in original data
animation_data <- animation_data %>%
  mutate(frameId = ifelse(frameId > pause_frame, frameId + pause_length, frameId))

# Combine the original and duplicated frames
animation_data <- bind_rows(animation_data, pause_data_replicated)

# Sort the data by frameId
animation_data <- animation_data %>% arrange(frameId)

# Create the plot
p <- nfl_field(c(0, 120)) +
  geom_point(
    data = animation_data, aes(x = x, y = y, color = club),
    show.legend = FALSE,
    size = 2
  ) +
  geom_point(
    data = animation_data %>% filter(nflId == ballCarrierId), aes(x = x, y = y),
    color = "brown4",
    show.legend = FALSE,
    size = 2
  ) +
  geom_hline(data = animation_data %>% filter(nflId == edgeSetterId_atFrame), 
             aes(yintercept = y), color = "darkblue") +
  geom_hline(data = animation_data %>% filter(nflId == edgeSetterId_atMaxChange) %>% filter(frameId <= 3), 
             aes(yintercept = y), color = "darkblue") +
  geom_point(
    data = animation_data %>% filter(nflId == edgeSetterId_atFrame), aes(x = x, y = y),
    color = "darkblue",
    show.legend = FALSE,
    size = 2 + (animation_data %>% filter(nflId == edgeSetterId_atFrame) %>% 
                  mutate(EIRscale = (edge_intensity_rating / 100)*2) %>% select(EIRscale) %>% pull())
  ) +
  # When frameId is less than 5 make edgeSetterId_at_max_change increase in size
  geom_point(
    data = animation_data %>% filter(nflId == edgeSetterId_atMaxChange) %>% filter(frameId <= 3), aes(x = x, y = y),
    color = "darkblue",
    show.legend = FALSE,
    size = 4
  ) +
  scale_color_manual(values = c("deepskyblue", "brown4", "firebrick2"))

# Create the animation
anim <- p +
  transition_time(frameId)

# Render the animation
animate(anim, fps = fps, start_pause = 10, res = 100)
```


# Animation for EIR

```{r}
nfl_field <- function(xlims) {
  geom_football(
    league = "nfl",
    display_range = "in_bounds_only",
    x_trans = 60,
    y_trans = 26.6667,
    xlims = xlims,
    color_updates = field_params
  )
}

animation_data2 <- combined_data %>% 
  mutate(normalize_total_change = (total_change - min(total_change, na.rm = TRUE)) / 
           (max(total_change, na.rm = TRUE) - min(total_change, na.rm = TRUE))) %>%
  
  mutate(normalize_EIR = (edge_intensity_rating_no_time - min(edge_intensity_rating_no_time, na.rm = TRUE)) / 
           (max(edge_intensity_rating_no_time, na.rm = TRUE) - min(edge_intensity_rating_no_time, na.rm = TRUE))) %>%
  filter(gamePlayId == "2022091500 1983")
edge_players <- animation_data2 %>% filter(!is.na(edge_intensity_rating)) %>% group_by(frameId) %>%
               filter(edge_intensity_rating == max(edge_intensity_rating, na.rm = T))
p2 <- nfl_field(c(60, 100)) +
  geom_point(
    data = animation_data2, aes(x = x, y = y, color = club),
    show.legend = FALSE,
    size = 2
  ) +
  geom_point(
    data = animation_data2 %>% filter(nflId == ballCarrierId), aes(x = x, y = y),
    color = "brown4",
    show.legend = FALSE,
    size = 2
  ) +
  geom_hline(data = edge_players, 
             aes(yintercept = y), color = "darkblue") +
  geom_point(data = edge_players, 
             aes(x = x, y = y), color = "darkblue", 
             size = 2 + (edge_players$edge_intensity_rating / 100)*2.5) +
  transition_time(frameId) +
  scale_color_manual(values = c("brown4", "deepskyblue", "firebrick2")) 

animating_graphs <- animation_data2 %>% group_by(frameId)  %>%
  distinct(frameId, edge_intensity_rating_no_time, normalize_total_change) 
  

p3 <- ggplot(animating_graphs, aes(x = frameId - first(animation_data2$start_frameId))) +
  geom_line(aes(y = normalize_total_change, color = "Ball Carrier\nDirection Change"), linewidth = 2) +
  geom_line(data = animating_graphs %>% group_by(frameId) %>%
              filter(edge_intensity_rating_no_time == max(edge_intensity_rating_no_time, na.rm = TRUE)),
            aes(y = edge_intensity_rating_no_time, color = "Edge Intensity\nRating"), linewidth = 2) +
  transition_reveal(frameId) +
  geom_vline(xintercept = animation_data2$frameId_at_max_change - first(animation_data2$start_frameId) - 1, color = "black", linetype = "dashed") +
  geom_vline(xintercept = animation_data2$frameId_at_max_change - first(animation_data2$start_frameId), color = "black", linetype = "dashed") +
  scale_x_continuous(breaks = seq(first(animation_data2$start_frameId)+1 - first(animation_data2$start_frameId),
                                  first(animation_data2$frameId_at_max_change) - first(animation_data2$start_frameId), 
                                  1), 
                     limits = c(first(animation_data2$start_frameId)+1 - first(animation_data2$start_frameId),
                                first(animation_data2$frameId_at_max_change) - first(animation_data2$start_frameId))) +
  scale_color_manual(values = c("Edge Intensity\nRating" = "purple", "Ball Carrier\nDirection Change" = "grey30"),
                     breaks = c("Edge Intensity\nRating", "Ball Carrier\nDirection Change")) +
  scale_y_continuous(limits = c(0,.75)) +
  labs(title = "As Edge Intensity Rating Increases, Ball Carrier\nTotal Change in Direction Increases",
       subtitle = "*With time not factored into EIR.",
       x = "Miliseconds After Handoff", y = "Normalized Value", color = "Legend:") +
  # Remove grid lines
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  theme(
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 12),
        legend.key.size = unit(1, "cm"),
        legend.text = element_text(size = 12))

library(magick)
field_g <- animate(p2, fps =10, width = 600, height = 290)
image_write(field_g, "field.gif")
field_gif <- image_read("field.gif")
cropped_image <- image_crop(field_gif, "420x290+100+0")
rotated_image <- image_rotate(cropped_image, -90)
rotated_image <- image_crop(rotated_image, "600x290+0+100")
image_write(rotated_image, "field.gif")
field_gif <- image_read("field.gif")
graph_g <- animate(p3, fps = 10, width = 450, height = 280)
image_write(graph_g, "graph.gif")
graph_gif <- image_read("graph.gif")

comb_gif <- image_append(c(field_gif[1], graph_gif[1]), stack = FALSE)
for(i in 2:100){
  combined <- image_append(c(field_gif[i], graph_gif[i]), stack = FALSE)
  comb_gif <- c(comb_gif, combined)
}
comb_gif
```



# Top 10 Edge Setters Table

```{r}
eir_df <- read.csv("edge-setting-epa/eir_epa.csv") %>% select(-1)
```

Clean eir_df for plot purposes.
```{r}
# Round values to 2 decimal places
eir_df$setting_freq <- round(eir_df$setting_freq, 2)
eir_df$pretty_freq <- paste0(eir_df$setting_freq * 100, "%")
eir_df$meanEIR <- round(eir_df$meanEIR, 2)
eir_df$meanTime <- round(eir_df$meanTime, 2)
eir_df$freqEIR <- round(eir_df$setting_freq * eir_df$meanEIR, 4)
eir_df$percentile <- round(percent_rank(eir_df$freqEIR),3) * 100
```


## EIR left table
```{r}
eir_df_left <- eir_df %>%
    filter(playSide == "left")
  
eir_df_left <- eir_df_left[order(-eir_df_left$meanEIR), ]
eir_df_left <- eir_df_left[order(-eir_df_left$freqEIR), ]

# Make pretty column names
names(eir_df_left) <- c("Team", "Name", "Playside", "Num. Plays",
                   "Num. Plays for Player", "prop", "Avg Time",
                   "Avg EIR", "Avg EPA", "Setting Freq", "Weighted EIR", "Percentile")

drops <- c("Playside")
eir_df_left <- eir_df_left[ , !(names(eir_df_left) %in% drops)]

eir_df_left %>%
  head(10) %>%
  select('Team', 'Name', 'Setting Freq', 'Avg Time', 'Avg EIR', 'Avg EPA', "Percentile") %>%
  gt() %>%
  fmt_number(
    columns = c("Avg EPA"), 
    decimals = 2
  ) %>% 
  tab_header(
    title = "Top 10 Left Edge Setters"
  ) %>% data_color(
    columns = c("Percentile"),
    fn = scales::col_numeric(
      palette = c("lightblue", "darkblue"),
      domain = NULL
    ))

```


## Top 10 EIR right
```{r}
eir_df_right <- eir_df %>%
    filter(playSide == "right")
  
eir_df_right <- eir_df_right[order(-eir_df_right$meanEIR), ]
eir_df_right <- eir_df_right[order(-eir_df_right$freqEIR), ]

# Make pretty column names
names(eir_df_right) <- c("Team", "Name", "Playside", "Num. Plays",
                   "Num. Plays for Player", "prop", "Avg Time",
                   "Avg EIR", "Avg EPA", "Setting Freq", "Weighted EIR", "Percentile")

drops <- c("Playside")
eir_df_right <- eir_df_right[ , !(names(eir_df_right) %in% drops)]

eir_df_right %>%
  head(10) %>%
  select('Team', 'Name', 'Setting Freq', 'Avg Time', 'Avg EIR', 'Avg EPA', "Percentile") %>%
  gt() %>%
  fmt_number(
    columns = c("Avg EPA"), 
    decimals = 2
  ) %>% 
  tab_header(
    title = "Top 10 Right Edge Setters"
  ) %>% data_color(
    columns = c("Percentile"),
    fn = scales::col_numeric(
      palette = c("pink", "firebrick4"),
      domain = NULL
    ))
```




# Some data prep
```{r}
edgeinfo <- combined_data %>% filter(nflId == edgeSetterId_atFrame) %>%
  select(gamePlayId, frameId, nflId, 
         ballCarrier_x, ballCarrier_y, ballCarrier_o, ballCarrier_s, ballCarrier_a, 
         x, y, s, a, relative_o_to_ballCarrier) %>%
   mutate(
    # Convert orientations to radians
    ballCarrier_o_rad = ballCarrier_o * (pi / 180),
    edgeDef_o_rad = relative_o_to_ballCarrier * (pi / 180),

    # Calculate components of velocity
    ballCarrier_velocity_x = ballCarrier_s * cos(ballCarrier_o_rad),
    ballCarrier_velocity_y = ballCarrier_s * sin(ballCarrier_o_rad),
    edgeDef_velocity_x = s * cos(edgeDef_o_rad),
    edgeDef_velocity_y = s * sin(edgeDef_o_rad),

    # Calculate vector from edge setter to ball carrier
    vector_to_ballCarrier_x = ballCarrier_x - x,
    vector_to_ballCarrier_y = ballCarrier_y - y,

    # Project speed of edge setter towards ball carrier
    edgeDef_speed_towards_ballCarrier = (edgeDef_velocity_x * vector_to_ballCarrier_x +
      edgeDef_velocity_y * vector_to_ballCarrier_y) /
      sqrt(vector_to_ballCarrier_x^2 + vector_to_ballCarrier_y^2),
    
    # Calculate components of acceleration
    ballCarrier_acceleration_x = ballCarrier_a * cos(ballCarrier_o_rad),
    ballCarrier_acceleration_y = ballCarrier_a * sin(ballCarrier_o_rad),
    edgeDef_acceleration_x = a * cos(edgeDef_o_rad),
    edgeDef_acceleration_y = a * sin(edgeDef_o_rad),

    # Calculate vector from edge defender to ball carrier
    vector_to_ballCarrier_x = ballCarrier_x - x,
    vector_to_ballCarrier_y = ballCarrier_y - y,

    # Project acceleration of edge defender towards ball carrier
    edgeDef_acceleration_towards_ballCarrier = (edgeDef_acceleration_x * vector_to_ballCarrier_x +
                                                edgeDef_acceleration_y * vector_to_ballCarrier_y) /
                                               sqrt(vector_to_ballCarrier_x^2 + vector_to_ballCarrier_y^2),

  ) %>%
  select(gamePlayId, frameId, edgeDef_speed_towards_ballCarrier, edgeDef_acceleration_towards_ballCarrier) 

combined_data <- left_join(combined_data, edgeinfo, by = c("gamePlayId", "frameId"))

normalized_EIR_ratings <- combined_data %>% 
  mutate(frames_from_start = frameId - start_frameId) %>% 
  filter(frameId >= start_frameId & frameId <= frameId_at_max_change + 1) %>%
  filter(frames_from_start <= 30) %>%
  filter(nflId == edgeSetterId_atFrame) %>%
  mutate(
    # Calculate edge defender's angle relative to ball carrier's ideal path
    angle_toIdealPath = ifelse(playSide == "left",
      (360 - ((angle_toballCarrier - ballCarrier_o) + 360) %% 360),
      ((angle_toballCarrier - ballCarrier_o) + 360) %% 360
    )
  ) %>%
  mutate(
    # Normalization of variables on a scale of 0 to 1 (0 worse, 1 better)
    
    # Scaling variables where lower is better
    
    # Distance to ball carrier
    scale_dist = 1 - 
      (distance_from_ballCarrier - min(distance_from_ballCarrier, na.rm = TRUE)) / 
      (max(distance_from_ballCarrier, na.rm = TRUE) - min(distance_from_ballCarrier, na.rm = TRUE)),
    
    # Speed of ball carrier
    scale_s = 1 - 
      (ballCarrier_s - min(ballCarrier_s, na.rm = TRUE)) / 
      (max(ballCarrier_s, na.rm = TRUE) - min(ballCarrier_s, na.rm = TRUE)),
    
    # Acceleration of ball carrier
    scale_a = 1 - 
      (ballCarrier_a - min(ballCarrier_a, na.rm = TRUE)) / 
      (max(ballCarrier_a, na.rm = TRUE) - min(ballCarrier_a, na.rm = TRUE)),
    
    # Time from handoff until edge is set
    scale_time = 1 - 
      (frames_from_start - min(frames_from_start, na.rm = TRUE)) / 
      (max(frames_from_start, na.rm = TRUE) - min(frames_from_start, na.rm = TRUE)),

    # Scaling variables where higher is better
    
    # Speed of defender towards ball carrier relative to how close a player is to ball carrier
    edgeDef_speed_towards_bc_relative = edgeDef_speed_towards_ballCarrier * scale_dist,
    scale_speed_towards_bc = 
      ((edgeDef_speed_towards_bc_relative - min(edgeDef_speed_towards_bc_relative, na.rm = TRUE)) /
      (max(edgeDef_speed_towards_bc_relative, na.rm = TRUE) - min(edgeDef_speed_towards_bc_relative, na.rm = TRUE))),
    
    # Acceleration of defender towards ball carrier
    edgeDef_acceleration_towards_bc_relative = edgeDef_acceleration_towards_ballCarrier * scale_dist,
    scale_acceleration_towards_bc = 
      ((edgeDef_acceleration_towards_bc_relative - min(edgeDef_acceleration_towards_bc_relative, na.rm = TRUE)) /
      (max(edgeDef_acceleration_towards_bc_relative, na.rm = TRUE) - min(edgeDef_acceleration_towards_bc_relative, na.rm = TRUE))),
    
    # Total change of ball carrier
    scale_total_change = 
      (total_change - min(total_change, na.rm = TRUE)) / 
      (max(total_change, na.rm = TRUE) - min(total_change, na.rm = TRUE)),
    
    # Scaling degrees variables
    
    # Orientation of defender relative to ball carrier
    scale_o_to_bc = ((cos(pi * relative_o_to_ballCarrier / 180) + 1) / 2) * scale_dist,  
    
    # Angle of defender relative to ball carrier's ideal path
    scale_angle_to_path = ((cos(pi * angle_toIdealPath / 180) + 1) / 2) * scale_dist,
    
  ) %>%
  mutate(normalize_EIR = (edge_intensity_rating_no_time - min(edge_intensity_rating_no_time, na.rm = TRUE)) / 
           (max(edge_intensity_rating_no_time, na.rm = TRUE) - min(edge_intensity_rating_no_time, na.rm = TRUE))) %>%
  select(gamePlayId, frameId, scale_dist, scale_s, scale_a, scale_time, 
         scale_speed_towards_bc, scale_acceleration_towards_bc, scale_total_change, 
         scale_o_to_bc, scale_angle_to_path, normalize_EIR) 

combined_data <- left_join(combined_data, normalized_EIR_ratings, by = c("gamePlayId", "frameId")) 
  
```

# Niners vs Rams game play animation

```{r}
SFLA_full <- combined_data %>% filter(gameId == 2022100300)

# 2022100300 3793
#2022100300 1942
animation_data <- SFLA_full %>% filter(gamePlayId == "2022100300 3793")

# Frame where you want to pause
pause_frame <- animation_data$frameId_at_max_change[1] - 1

# Number of times to duplicate the pause frame (5 seconds * fps)
fps <- 10 # frames per second
pause_length <- fps * 5 


# Duplicate the pause frame and create increasing frameIds
pause_data <- animation_data %>% filter(frameId == pause_frame) %>% 
  filter(nflId == ballCarrierId | nflId == edgeSetterId_atFrame)
pause_data_replicated <- pause_data %>%
  slice(rep(1, pause_length)) %>%
  mutate(frameId = frameId + 0:(pause_length - 1))

# Adjust frameId for subsequent frames in original data
animation_data <- animation_data %>%
  mutate(frameId = ifelse(frameId > pause_frame, frameId + pause_length, frameId))

# Combine the original and duplicated frames
animation_data <- bind_rows(animation_data, pause_data_replicated)

# Sort the data by frameId
animation_data <- animation_data %>% arrange(frameId)

# Create the plot
p <- nfl_field(c(0, 120)) +
  geom_point(
    data = animation_data %>% filter(club != "football"),
    aes(x = x, y = y, color = club),
    show.legend = FALSE,
    size = 2
  ) +
  geom_point(
    data = animation_data %>% filter(nflId == ballCarrierId), aes(x = x, y = y),
    color = "white",
    show.legend = FALSE,
    size = 2
  ) +
  geom_hline(data = animation_data %>% filter(nflId == edgeSetterId_atFrame), 
             aes(yintercept = y), color = "#FFD100") +
  geom_hline(data = animation_data %>% filter(nflId == edgeSetterId_atMaxChange) %>% filter(frameId <= 3), 
             aes(yintercept = y), color = "#FFD100") +
  geom_point(
    data = animation_data %>% filter(nflId == edgeSetterId_atFrame), aes(x = x, y = y),
    color = "#FFD100",
    show.legend = FALSE,
    size = 2
    #size = 2 + (animation_data %>% filter(nflId == edgeSetterId_atFrame) %>% 
     #             mutate(EIRscale = (edge_intensity_rating / 100)*2) %>% select(EIRscale) %>% pull())
  ) +
  # When frameId is less than 5 make edgeSetterId_at_max_change increase in size
  geom_point(
    data = animation_data %>% filter(nflId == edgeSetterId_atMaxChange) %>% filter(frameId <= 3), aes(x = x, y = y),
    color = "#FFD100",
    show.legend = FALSE,
    size = 2
  ) +
  scale_color_manual(values = c("#003594", "#c9243f"))

# Create the animation
anim <- p +
  transition_time(frameId)

# Render the animation
animate(anim, fps = fps, start_pause = 10, width = 1920, height = 1080, res = 250)
```

# Graph Animation
```{r}
animating_graphs <- animation_data %>% 
  group_by(frameId)  %>%
  distinct(frameId, edge_intensity_rating_no_time, normalize_total_change) 

p3 <- ggplot(animating_graphs, aes(x = frameId - first(animation_data$start_frameId))) +
  geom_line(aes(y = normalize_total_change, color = "Ball Carrier\nDirection Change"), linewidth = 2) +
  geom_line(data = animating_graphs %>% group_by(frameId) %>%
              filter(edge_intensity_rating_no_time == max(edge_intensity_rating_no_time, na.rm = TRUE)),
            aes(y = edge_intensity_rating_no_time, color = "Edge Intensity\nRating"), linewidth = 2) +
  transition_reveal(frameId) +
  geom_vline(xintercept = animation_data$frameId_at_max_change - first(animation_data$start_frameId) - 1, color = "black", linetype = "dashed") +
  geom_vline(xintercept = animation_data$frameId_at_max_change - first(animation_data$start_frameId), color = "black", linetype = "dashed") +
  scale_x_continuous(breaks = seq(first(animation_data$start_frameId)+1 - first(animation_data$start_frameId),
                                  first(animation_data$frameId_at_max_change) - first(animation_data$start_frameId), 
                                  1), 
                     limits = c(first(animation_data$start_frameId)+1 - first(animation_data$start_frameId),
                                first(animation_data$frameId_at_max_change) - first(animation_data$start_frameId))) +
  scale_color_manual(values = c("Edge Intensity\nRating" = "purple", "Ball Carrier\nDirection Change" = "grey30"),
                     breaks = c("Edge Intensity\nRating", "Ball Carrier\nDirection Change")) +
  scale_y_continuous(limits = c(0,.75)) +
  labs(title = "As Edge Intensity Rating Increases, Ball Carrier\nTotal Change in Direction Increases",
       subtitle = "*With time not factored into EIR.",
       x = "Frames After Handoff", y = "Normalized Value", color = "Legend:") +
  # Remove grid lines
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  theme(
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 12),
        legend.key.size = unit(1, "cm"),
        legend.text = element_text(size = 12))
```

```{r}
library(magick)
field_g <- animate(anim, fps = fps, start_pause = 10, width = 1920, height = 1080, res = 250)
image_write(field_g, "field.gif")
field_gif <- image_read("field.gif")
cropped_image <- image_crop(field_gif, "960x1080+100+0")
rotated_image <- image_rotate(cropped_image, -90)
rotated_image <- image_crop(rotated_image, "1000x860+0+0")
image_write(rotated_image, "field.gif")
field_gif <- image_read("field.gif")
graph_g <- animate(p3, fps = 10, start_pause = 10, width = 1200, height = 800, res = 250)
image_write(graph_g, "graph.gif")
graph_gif <- image_read("graph.gif")

comb_gif <- image_append(c(field_gif[1], graph_gif[1]), stack = FALSE)
for(i in 2:100){
  combined <- image_append(c(field_gif[i], graph_gif[i]), stack = FALSE)
  comb_gif <- c(comb_gif, combined)
}
comb_gif
```


```{r}
animating_graphs <- animation_data %>% 
  filter(nflId == edgeSetterId_atFrame | is.na(scale_s)) %>%
  group_by(frameId)  %>%
  distinct(frameId, edge_intensity_rating_no_time, 
           scale_total_change, scale_s, scale_a,
           scale_dist, scale_speed_towards_bc, scale_acceleration_towards_bc, 
           scale_o_to_bc, scale_angle_to_path,
           scale_time 
           ) 


p3 <- ggplot(animating_graphs, aes(x = frameId - first(animation_data$start_frameId))) +
  geom_line(aes(y = scale_total_change, 
                color = factor("Ball Carrier Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_s, 
                color = factor("Ball Carrier Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_a, 
                color = factor("Ball Carrier Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_dist, 
                color = factor("Edge Setter Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_speed_towards_bc, 
                color = factor("Edge Setter Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_acceleration_towards_bc, 
                color = factor("Edge Setter Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_o_to_bc, 
                color = factor("Edge Setter Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_angle_to_path, 
                color = factor("Edge Setter Metrics")), alpha = 0.25, lwd = 1.5) +
  geom_line(aes(y = scale_time, 
                color = factor("Time")), alpha = 0.25, lwd = 1.5) +
  geom_line(data = animating_graphs %>% group_by(frameId) %>%
              filter(edge_intensity_rating_no_time == max(edge_intensity_rating_no_time, na.rm = TRUE)),
            aes(y = edge_intensity_rating_no_time, 
                color = factor("Edge Intensity Rating")), linewidth = 2.5) +
  transition_reveal(frameId) +
  geom_vline(xintercept = animation_data$frameId_at_max_change - first(animation_data$start_frameId) - 1, color = "black", linetype = "dashed") +
  geom_vline(xintercept = animation_data$frameId_at_max_change - first(animation_data$start_frameId), color = "black", linetype = "dashed") +
  scale_x_continuous(breaks = seq(first(animation_data$start_frameId)+1 - first(animation_data$start_frameId),
                                  first(animation_data$frameId_at_max_change) - first(animation_data$start_frameId), 
                                  1), 
                     limits = c(first(animation_data$start_frameId)+1 - first(animation_data$start_frameId),
                                first(animation_data$frameId_at_max_change) - first(animation_data$start_frameId))) +
  scale_color_manual(values = c("Edge Intensity Rating" = "firebrick2", 
                                "Ball Carrier Metrics" = "lightgoldenrod3",
                                "Edge Setter Metrics" = "palegreen3",
                                "Time" = "steelblue1"),
                     breaks = c("Edge Intensity Rating", 
                                "Ball Carrier Metrics",
                                "Edge Setter Metrics",
                                "Time")) +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = "Edge Intensity Level as the\nPlay Develops",
       x = "Frames After Handoff", y = "Normalized Value", color = "Legend:") +
  # Remove grid lines
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  theme(
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 12),
        legend.key.size = unit(1, "cm"),
        legend.text = element_text(size = 10))
```


```{r}
library(magick)
field_g <- animate(anim, fps = fps, start_pause = 10, width = 1920, height = 1080, res = 250)
image_write(field_g, "field.gif")
field_gif <- image_read("field.gif")
cropped_image <- image_crop(field_gif, "960x1080+100+0")
rotated_image <- image_rotate(cropped_image, -90)
rotated_image <- image_crop(rotated_image, "1000x860+0+0")
image_write(rotated_image, "field.gif")
field_gif <- image_read("field.gif")
graph_g <- animate(p3, fps = 10, start_pause = 10, width = 1300, height = 800, res = 250)
image_write(graph_g, "graph.gif")
graph_gif <- image_read("graph.gif")

comb_gif <- image_append(c(field_gif[1], graph_gif[1]), stack = FALSE)
for(i in 2:100){
  combined <- image_append(c(field_gif[i], graph_gif[i]), stack = FALSE)
  comb_gif <- c(comb_gif, combined)
}
comb_gif
```