---
title: "Graphs"
author: "Shane Hauck, Marion Haney, Devin Basley, Vinay Maruri"
date: "2024-1-3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gganimate)
library(ggplot2)
library(magick)
library(cowplot)
library(grid)
theme_set(theme_bw())
```

Read in processed data files and combine:
```{r}
file_pattern <- "^wk[123456789]_processed_data\\.csv$"
files <- list.files(path = "data", pattern = file_pattern, full.names = TRUE)
combined_data <- map_df(files, read.csv)
data <- combined_data %>% 
  filter(frameId == frameId_at_max_change) %>%
  filter(nflId == ballCarrierId)
data <- filter(data, !is.na(expectedPointsAdded))

```

EDA (to check work)

Histogram of total change (angle change + orientation change)
```{r}
ggplot(data = data, aes(x = total_change)) +
  geom_histogram()
```


Filter the data: total change < 30 (where most of the data are)
```{r}
max_range <- 30
filtered_data <- filter(data, total_change < max_range)
```


Create buckets for EDA
```{r}
bucket_size <- 5
filtered_data$bucket <- cut(filtered_data$total_change, breaks = seq(0, max_range, bucket_size), 
                                            labels = FALSE, right = FALSE)
```


Histogram of total change (angle change + orientation change) for each bucket
```{r}
ggplot(data = filtered_data, aes(x = total_change)) +
  geom_histogram() +
  facet_wrap(~factor(bucket))
```

Get average EPA by bucket
```{r}
avg_epa_by_bucket <- filtered_data %>%
  group_by(bucket) %>%
  reframe(epa = mean(expectedPointsAdded),
            min_change = (bucket - 1) * bucket_size,
            max_change = bucket * bucket_size) %>%
  unique()
```


# Polar coordinate graphs


## EPA by total change

```{r}
plotdf <- data %>% 
  filter(total_change_at_max_change < 30) %>%
  select(total_change_at_max_change, expectedPointsAdded) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(0, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEPA = mean(expectedPointsAdded))
```

```{r}
# Read the football field image
football_field <- image_read("Untitled.png")

# Replace the checkerboard pattern with white color
football_field <- image_scale(football_field, "200%")
# Plot
plot <- ggplot(plotdf, aes(x = bucket_angle_min, y = 1, fill = meanEPA)) +
  geom_col() +
  coord_polar() +
  scale_x_continuous(limits = c(0,180)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(low = "darkblue", high = "firebrick4", midpoint = mean(plotdf$meanEPA, na.rm = TRUE)) +
  labs(title = "Expected Points Added", 
       subtitle = "By a ball carrier's highest change in angular direction (0 = no change, 50 = right, 150 = left", 
       x = "Total Change", y = "", fill = "EPA") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.key.size = unit(1, "cm"))

# Create a plot with the football field background
plot_with_background <- ggdraw() +
  draw_image(football_field, scale = 1) +
  draw_plot(plot)

# Display the plot
plot_with_background
```


## EPA by relative total change

```{r}
plotdf <- data %>% 
  filter(abs(relative_total_change) < 25) %>%
  select(relative_total_change, expectedPointsAdded) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-25, 25, 5))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket))),
         bucket_angle_max = as.numeric(gsub("\\[|\\]", "", gsub(".*,(.*)\\]", "\\1", as.character(bucket)))),
         bucket_angle_mean = (bucket_angle_min + bucket_angle_max) / 2) %>%
  mutate(meanEPA = mean(expectedPointsAdded))
```

```{r}
# Read the football field image
football_field <- image_read("Untitled.png")

# Replace the checkerboard pattern with white color
football_field <- image_scale(football_field, "200%")
# Plot
plot <- ggplot(plotdf, aes(x = bucket_angle_mean, y = 1)) +
  geom_col(aes(fill = meanEPA)) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-180,180)) +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = "EPA by Relative Total Change", 
       x = "Relative Total Change", y = " ", 
       subtitle = "Values < 0 are Cutbacks, Values > 0 are Bounces",
       fill = "EPA")  +
  scale_fill_gradient2(low = "darkblue", high = "firebrick4", midpoint = mean(plotdf$meanEPA, na.rm = TRUE)) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.key.size = unit(1, "cm"))

# Create a plot with the football field background
plot_with_background <- ggdraw() +
  draw_image(football_field, scale = 1) +
  draw_plot(plot)

# Display the plot
plot_with_background

```


## EPA of relative total change by play side

```{r}
plotdf3 <- data %>% 
  filter(abs(relative_total_change) < 25) %>%
  select(relative_total_change, expectedPointsAdded, playSide) %>%
  group_by(playSide) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-25, 25, 15))
         ) %>%
  group_by(playSide, bucket) %>%
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket))),
         bucket_angle_max = as.numeric(gsub("\\[|\\]", "", gsub(".*,(.*)\\]", "\\1", as.character(bucket)))),
         bucket_angle_mean = (bucket_angle_min + bucket_angle_max) / 2) %>%
  mutate(meanEPA = mean(expectedPointsAdded)) %>%
  mutate(playSidedescr = ifelse(playSide == "left", "Plays to the Left", "Plays to the Right"))
```





```{r}
# Read the football field image
football_field <- image_read("Untitled.png")

# Replace the checkerboard pattern with white color
football_field <- image_scale(football_field, "200%")

# Plot 4
plot <- ggplot(plotdf3, aes(x = bucket_angle_mean, y = 1)) +
  geom_col(aes(fill = meanEPA)) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-50, 50)) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(title = "EPA by Direction of Greatest Cut", x = "", y = " ", subtitle = "Considering the direction of the playside:", fill = "EPA") +
  scale_fill_gradient2(low = "darkblue", high = "firebrick4", midpoint = mean(plotdf3$meanEPA, na.rm = TRUE)) +
  facet_wrap(~playSidedescr, strip.position = "top", nrow = 1) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(size = 16, margin = margin(t = 10)),
        plot.subtitle = element_text(size = 12),
        strip.text = element_text(size = 12, margin = margin(t=25)))

# Create a plot with the football field background
plot_with_background <- ggdraw() +
  draw_image(football_field, scale = 1) +
  draw_plot(plot)

# Display the plot
plot_with_background
```




