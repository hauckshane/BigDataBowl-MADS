---
title: "Graphs"
author: "Shane Hauck, Marion Haney, Devin Basley, Vinay Maruri"
date: "2024-1-3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gganimate)
theme_set(theme_bw())
```

```{r}
library(sportyR)
field_params <- list(
  field_apron = "lightgray",
  field_border = "lightgray",
  offensive_endzone = "lightgray",
  defensive_endzone = "lightgray",
  offensive_half = "lightgray",
  defensive_half = "lightgray"
)

nfl_field <- function(xlims) {
  geom_football(
    league = "nfl",
    display_range = "full",
    x_trans = 60,
    y_trans = 26.6667,
    xlims = xlims,
    color_updates = field_params
  )
}
```


Read in processed data files and combine:
```{r}
# MARION make sure this stuff is loading in the EIR stuff
file_pattern <- "^wk[123456789]_processed_data\\.csv$"
files <- list.files(path = "data", pattern = file_pattern, full.names = TRUE)
combined_data <- map_df(files, read.csv)
data <- combined_data %>% 
  filter(frameId == frameId_at_max_change) %>% # Shouldnt have to do this filtering if you read maxChangesEIR
  filter(nflId == ballCarrierId)
data <- filter(data, !is.na(expectedPointsAdded)) # Filtering should've be taken care of in Edge-Intensity-Rating
```

```{r}
# From Edge-Intensity_Rating
maxChangesEIR <- read_csv("data/BC_and_ES_information.csv") # MARION this is same thing as data just my updated version

combined_data <- read_csv("data/all_processed_data.csv")
```


EDA (to check work)

Histogram of total change (angle change + orientation change)
```{r}
ggplot(data = data, aes(x = total_change_at_max_change)) +
  geom_histogram()
```


Filter the data: total change < 30 (where most of the data are)
```{r}
# Did this in EIR
max_range <- 30
filtered_data <- filter(data, total_change_at_max_change < max_range)
```


Create buckets for EDA
```{r}
bucket_size <- 5
filtered_data$bucket <- cut(filtered_data$total_change, breaks = seq(0, max_range, bucket_size), 
                                            labels = FALSE, right = FALSE)
```


Histogram of total change (angle change + orientation change) for each bucket
```{r}
ggplot(data = filtered_data, aes(x = total_change)) +
  geom_histogram() +
  facet_wrap(~factor(bucket))
```

Get average EPA by bucket
```{r}
avg_epa_by_bucket <- filtered_data %>%
  group_by(bucket) %>%
  reframe(epa = mean(expectedPointsAdded),
            min_change = (bucket - 1) * bucket_size,
            max_change = bucket * bucket_size) %>%
  unique()
```


# Polar coordinate graphs


## EPA by total change

**Plot 1**
```{r}
plotdf <- maxChangesEIR %>% 
  select(total_change_at_max_change, expectedPointsAdded) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(0, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEPA = mean(expectedPointsAdded))
```

```{r}
# Plot
ggplot(plotdf, aes(x = bucket_angle_min, y = 1, fill = meanEPA)) +
  geom_col(color = "black", size = .15) +
  coord_polar() +
  scale_x_continuous(limits = c(0,360)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(low = "darkcyan", high = "firebrick4", midpoint = mean(plotdf$meanEPA, na.rm = TRUE)) +
  labs(title = "Ball Carrier's Greatest Total Change of Direction's Effect On EPA",
       subtitle = "As the ball carrier makes more significant maximal changes in direction, \nthe average offense success decreases.", 
       x = "Ball Carrier Total Change of Direction", y = "", fill = "Expected Points Added") +
  #theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"))
```


## EPA by relative total change



**Plot 2**
```{r}
plotdf <- maxChangesEIR %>% 
  filter(abs(relative_total_change) < 25) %>%
  select(relative_total_change, expectedPointsAdded) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-25, 25, 5))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket))),
         bucket_angle_max = as.numeric(gsub("\\[|\\]", "", gsub(".*,(.*)\\]", "\\1", as.character(bucket)))),
         bucket_angle_mean = (bucket_angle_min + bucket_angle_max) / 2) %>%
  mutate(meanEPA = mean(expectedPointsAdded))
```

```{r}
# Plot
ggplot(plotdf, aes(x = bucket_angle_mean, y = 1)) +
  geom_col(aes(fill = meanEPA), color = "black", size = .1) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-180,180)) +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = "Ball Carrier's Greatest Relative Total Change of Direction's \nEffect On EPA", 
       subtitle = "Edges that force the ball carrier to make a more drastic cutback to center or \nbounce to outside have a positive effect on EPA for the defense.",
       x = "Ball Carrier Relative Total Change of Direction", y = " ", 
       caption = "Relative Change < 0 = Cutbacks  \nRelative Change = 0 = Dive \nRelative Change > 0 = Bounces",
       fill = "Expected Points Added")  +
  scale_fill_gradient2(low = "darkcyan", high = "firebrick4", midpoint = mean(plotdf$meanEPA, na.rm = TRUE)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"),
        plot.caption = element_text(size = 18))

```


## EPA of relative total change by play side

**Plot 3**
```{r}
plotdf3 <- maxChangesEIR %>% 
  filter(abs(relative_total_change) < 25) %>%
  select(relative_total_change, expectedPointsAdded, playSide) %>%
  group_by(playSide) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-25, 25, 15))
         ) %>%
  group_by(playSide, bucket) %>%
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket))),
         bucket_angle_max = as.numeric(gsub("\\[|\\]", "", gsub(".*,(.*)\\]", "\\1", as.character(bucket)))),
         bucket_angle_mean = (bucket_angle_min + bucket_angle_max) / 2) %>%
  mutate(meanEPA = mean(expectedPointsAdded)) %>%
  mutate(playSidedescr = ifelse(playSide == "left", "Plays to the Left", "Plays to the Right"))
```

```{r}
# Plot
ggplot(plotdf3, aes(x = bucket_angle_mean, y = 1)) +
  geom_col(aes(fill = meanEPA), color = "black", size = .25) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-50,50)) +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = "EPA by Direction of Greatest Cut", x = "Greatest Change of Direction", y = " ", subtitle = "Considering the direction of the playside:", fill = "EPA")  +
  scale_fill_gradient2(low = "darkcyan", high = "firebrick4", midpoint = mean(maxChangesEIR$expectedPointsAdded, na.rm = TRUE)) +
  facet_wrap(~playSidedescr) +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.key.size = unit(1, "cm"),
        strip.text = element_text(size = 18))
```


# EIR impact on change of direction
**Plot 4**
```{r}
EIR_TC_plot <- maxChangesEIR %>%
  select(total_change_at_max_change, max_EIR_atMaxChange) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(0, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEIR = mean(max_EIR_atMaxChange))

ggplot(EIR_TC_plot, aes(x = bucket_angle_min, y = 1, fill = meanEIR)) +
  geom_col(color = "black", size = .15) +
  coord_polar() +
  scale_x_continuous(limits = c(0,360)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(low = "midnightblue", high = "sienna2", midpoint = mean(EIR_TC_plot$meanEIR, na.rm = TRUE)) +
  labs(title = "Edge Intensity Rating by Greatest Total Change of Direction", 
       subtitle = "Edges being set more intensely are associated with greater total change of ball carrier direction.", 
       x = "Ball Carrier Total Change of Direction", y = "", 
       fill = "Edge Intensity Rating") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"))
```

# EIR impact on relative change of direction
**Plot 5**

```{r}
EIR_RTC_plot <- maxChangesEIR %>%
  select(relative_total_change, max_EIR_atMaxChange) %>%
  mutate(bucket = cut(relative_total_change, breaks = seq(-30, 30, 3))
         ) %>% 
  group_by(bucket) %>% 
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  mutate(meanEIR = mean(max_EIR_atMaxChange))

ggplot(EIR_RTC_plot, aes(x = bucket_angle_min, y = 1, fill = meanEIR)) +
  geom_col(color = "black", size = 0.15) +
  coord_polar(start = 66) +
  scale_x_continuous(limits = c(-180,180)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(high = "sienna2", low = "midnightblue", midpoint = mean(maxChangesEIR$max_EIR_atMaxChange, na.rm = TRUE)) +
  labs(title = "Edge Intensity Rating by Relative Greatest Total Change of Direction", 
       subtitle = "Edges set more intensely are associated with greater total change of ball carrier direction.",
       x = "Ball Carrier Relative Total Change of Direction", y = " ", 
       caption = "Relative Change < 0 = Cutbacks  \nRelative Change = 0 = Dive \nRelative Change > 0 = Bounces",
       fill = "Edge Intensity Rating")  +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 24),
        plot.title = element_text(size = 32),
        plot.subtitle = element_text(size = 24),
        legend.text =  element_text(size = 18),
        legend.title = element_text(size = 24),
        legend.key.size = unit(2, "cm"),
        plot.caption = element_text(size = 18))
```

# EIR impact on change of direction over time
**Animation 1**
```{r}
quickest_set_plot <- maxChangesEIR %>%
  select(frames_from_start_atMaxChange, max_EIR_atMaxChange, total_change_at_max_change) %>%
  mutate(
    framesBucket = case_when(
      frames_from_start_atMaxChange <= 5 ~ "1",
      frames_from_start_atMaxChange > 5 & frames_from_start_atMaxChange <= 10 ~ "2",
      frames_from_start_atMaxChange > 10 & frames_from_start_atMaxChange <= 15 ~ "3",
      frames_from_start_atMaxChange > 15 & frames_from_start_atMaxChange <= 20 ~ "4",
      frames_from_start_atMaxChange > 20 & frames_from_start_atMaxChange <= 30 ~ "5",
      frames_from_start_atMaxChange > 30 ~ "6",
      TRUE ~ NA_character_  
    )
  ) %>%
  mutate(bucket = cut(total_change_at_max_change, breaks = seq(-30, 30, 6))) %>%
  mutate(bucket_angle_min = as.numeric(sub("\\((.*),.*", "\\1", as.character(bucket)))) %>%
  group_by(framesBucket, bucket) %>%
  mutate(expected_EIR = mean(max_EIR_atMaxChange)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(
    frames_sequence = list(
      if (framesBucket == "1") {
        1:5
      } else if (framesBucket == "2") {
        6:10
      } else if (framesBucket == "3") {
        11:15
      } else if (framesBucket == "4") {
        15:20
      } else if (framesBucket == "5") {
        21:30
      } else if (framesBucket == "6") {
        31:40
      }
      else {
        integer(0)  # Empty vector for NA or unexpected values
      }
    )
  ) %>%
  unnest(frames_sequence) %>%
  select(-frames_from_start_atMaxChange) %>%
  rename(frames_from_start_atMaxChange = frames_sequence) %>%
  mutate(seconds_from_start_atMaxChange = frames_from_start_atMaxChange / 10) 
  
p1 <- ggplot(quickest_set_plot, aes(x = bucket_angle_min, y = 1, fill = expected_EIR)) +
  geom_col(color = "black", size = .05) +
  coord_polar() +
  scale_x_continuous(limits = c(0,360)) +
  scale_y_continuous(limits = c(0,1)) +
  scale_fill_gradient2(high = "sienna2", low = "midnightblue", midpoint = mean(maxChangesEIR$max_EIR_atMaxChange, na.rm = TRUE)) +
  labs(title = "EIR for Total Change of Direction Seconds After Handoff",
       subtitle  = "\nSeconds after handoff: {closest_state}", 
       x = "Ball Carrier Total Change of Direction", y = "", 
       fill = "Edge Intensity Rating") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 12),
        legend.key.size = unit(2, "cm"))+
  transition_states(seconds_from_start_atMaxChange, transition_length = 0, state_length = 2, wrap = TRUE) +
  exit_fade() +
  ease_aes('linear') 
animate(p1, start_pause = 10, end_pause = 10, fps = 10)
```



# Animation for Angle Change

```{r}
combined_data <- read_csv("data/all_processed_data.csv")
```



```{r}
animation_data <- combined_data %>% filter(gamePlayId == "2022100910 2460")

# Frame where you want to pause
pause_frame <- animation_data$frameId_at_max_change[1]

# Number of times to duplicate the pause frame (5 seconds * fps)
fps <- 10 # frames per second
pause_length <- fps * 5 


# Duplicate the pause frame and create increasing frameIds
pause_data <- animation_data %>% filter(frameId == pause_frame) %>% filter(nflId == ballCarrierId | nflId == edgeSetterId_atFrame)
pause_data_replicated <- pause_data %>%
  slice(rep(1, pause_length)) %>%
  mutate(frameId = frameId + 0:(pause_length - 1))

# Adjust frameId for subsequent frames in original data
animation_data <- animation_data %>%
  mutate(frameId = ifelse(frameId > pause_frame, frameId + pause_length, frameId))

# Combine the original and duplicated frames
animation_data <- bind_rows(animation_data, pause_data_replicated)

# Sort the data by frameId
animation_data <- animation_data %>% arrange(frameId)

# Create the plot
p <- nfl_field(c(0, 120)) +
  geom_point(
    data = animation_data, aes(x = x, y = y, color = club),
    show.legend = FALSE,
    size = 2
  ) +
  geom_point(
    data = animation_data %>% filter(nflId == ballCarrierId), aes(x = x, y = y),
    color = "brown4",
    show.legend = FALSE,
    size = 2
  ) +
  geom_hline(data = animation_data %>% filter(nflId == edgeSetterId_atFrame), 
             aes(yintercept = y), color = "darkblue") +
  geom_hline(data = animation_data %>% filter(nflId == edgeSetterId_atMaxChange) %>% filter(frameId <= 3), 
             aes(yintercept = y), color = "darkblue") +
  geom_point(
    data = animation_data %>% filter(nflId == edgeSetterId_atFrame), aes(x = x, y = y),
    color = "darkblue",
    show.legend = FALSE,
    size = 2 + (animation_data %>% filter(nflId == edgeSetterId_atFrame) %>% 
                  mutate(EIRscale = (edge_intensity_rating / 100)*2) %>% select(EIRscale) %>% pull())
  ) +
  # When frameId is less than 5 make edgeSetterId_at_max_change increase in size
  geom_point(
    data = animation_data %>% filter(nflId == edgeSetterId_atMaxChange) %>% filter(frameId <= 3), aes(x = x, y = y),
    color = "darkblue",
    show.legend = FALSE,
    size = 4
  ) +
  scale_color_manual(values = c("deepskyblue", "brown4", "firebrick2"))

# Create the animation
anim <- p +
  transition_time(frameId)

# Render the animation
animate(anim, fps = fps, start_pause = 10)
```

